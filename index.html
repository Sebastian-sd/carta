<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Carta Villa Grill â€¢ Pedidos</title>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--text:#e5e7eb;--brand:#22c55e;--border:#213043}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0a0f1a);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);backdrop-filter:saturate(1.2) blur(6px);background:#0b1220cc}
    h1{font-size:clamp(18px,3.5vw,22px);margin:0;font-weight:800}
    .container{max-width:1100px;margin:0 auto;padding:14px}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
    .card{background:linear-gradient(180deg,#0e1628,#0b1220);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px #00000055}
    .section{padding:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar input[type="search"], .toolbar input[type="text"], select{border:1px solid var(--border);background:#0b1220;color:var(--text);border-radius:12px;padding:10px 12px;outline:none}
    .badge{padding:4px 10px;border:1px solid var(--border);border-radius:999px;color:#a5b4fc;background:#0b1220}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
    .item{border:1px solid var(--border);border-radius:14px;padding:10px;background:linear-gradient(180deg,#0c1425,#0b1220);display:grid;gap:8px}
    .item h3{margin:0;font-size:16px}
    .price{color:#93c5fd;font-weight:700}
    button{appearance:none;border:1px solid #1e293b;border-radius:10px;background:linear-gradient(180deg,#16a34a,#22c55e);color:#06240f;font-weight:800;padding:10px 12px;cursor:pointer}
    .ghost{background:#0b1220;color:#cbd5e1;border:1px dashed #334155}
    .cart{display:grid;gap:10px}
    .cart h2{margin:0 0 6px 0;font-size:18px}
    .row{display:flex;gap:8px;align-items:center}
    .kvs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .total{display:flex;align-items:center;justify-content:space-between;border-top:1px dashed var(--border);padding-top:8px;margin-top:6px}
    small.muted{color:var(--muted)}
    #registro{max-height:300px;overflow:auto;margin-top:16px;padding:6px;border:1px solid var(--border);border-radius:10px;background:#0e1628}
    #registro .pedido{border-bottom:1px solid #1f2937;padding:6px 0}
    /* Modal */
    .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;padding:16px}
    .modal.show{display:flex}
    .modal .box{position:relative;display:flex;flex-direction:column;width:min(700px,100%);max-height:90vh;overflow-y:auto;background:#0e1628;border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 20px 60px #000a}
    .modal h3{margin:0 0 6px 0}
    .opts{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;margin:8px 0}
    .opt{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:12px;padding:8px;background:#0b1220}
    .sw{width:18px;height:18px;border-radius:999px;border:1px solid #0003}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:auto;position:sticky;bottom:0;background:#0e1628;padding-top:8px}
    textarea{width:100%;min-height:60px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb;border-radius:12px;padding:8px;resize:vertical}
    .close-btn{position:absolute;top:8px;right:12px;background:none;border:none;font-size:20px;color:#cbd5e1;cursor:pointer}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <h1>Villa Grill â€¢ Pedidos</h1>
  <span class="badge" id="status">Desconectado</span>
</header>

<div class="container grid">
  <!-- IZQUIERDA: CARTA -->
  <section class="card section">
    <div class="toolbar">
      <input id="buscar" type="search" placeholder="Buscar (ej. hamburguesa, parrilla, salchipapas)" />
      <select id="categoria">
        <option value="">Todas las categorÃ­as</option>
        <option value="parrillas">Parrillas</option>
        <option value="hamburguesas">Hamburguesas</option>
        <option value="salchipapas">Salchipapas</option>
      </select>
      <span class="badge" id="itemsCount">0 Ã­tems</span>
    </div>

    <div id="menu" class="list" style="margin-top:12px"></div>
    <small class="muted">* Toca Â«PersonalizarÂ» para elegir cremas, tipo de papas y ensalada en Hamburguesas y Salchipapas.</small>
  </section>

  <!-- DERECHA: CARRITO / CLIENTE -->
  <aside class="card section">
    <div class="cart">
      <h2>Carrito</h2>
      <div id="carritoVacio" class="row"><small class="muted">AÃºn no hay productos. Agrega de la carta â†’</small></div>
      <div id="carrito"></div>
      <div class="kvs" style="margin-top:8px">
        <input id="cliente" type="text" placeholder="Nombre del cliente" />
        <select id="pago">
          <option value="pendiente">Por pagar</option>
          <option value="pagado">Pagado</option>
        </select>
      </div>
      <div class="total">
        <strong>Total: <span id="total">S/ 0.00</span></strong>
        <button id="enviar">Enviar pedido</button>
      </div>
      <small class="muted">Los pedidos se guardan en Firebase Realtime Database.</small>
    </div>
  </aside>
</div>

<!-- Registro del dÃ­a -->
<section class="container card section" style="margin-top:12px">
  <h2 style="margin:0 0 8px 0">Registro de pedidos (hoy)</h2>
  <div id="registro" class="list" style="grid-template-columns:1fr; gap:8px"></div>
</section>

<!-- Modal de personalizaciÃ³n -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <button class="close-btn" id="cerrarModal">âœ•</button>
    <h3 id="modalTitle">Personalizar</h3>
    <div id="modalBody"></div>
    <div class="actions">
      <button class="ghost" id="cancelar">Cancelar</button>
      <button id="guardarPersonalizacion">Agregar</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onChildChanged, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // ðŸ”‘ PON AQUÃ TU API KEY REAL
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "parrillas-66b0e.firebaseapp.com",
    databaseURL: "https://parrillas-66b0e-default-rtdb.firebaseio.com",
    projectId: "parrillas-66b0e",
    storageBucket: "parrillas-66b0e.appspot.com",
    messagingSenderId: "520361790818",
    appId: "1:520361790818:web:36b65573eabde389c9f03b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const $ = s => document.querySelector(s);
  const menuEl=$('#menu'), buscarEl=$('#buscar'), catEl=$('#categoria'), itemsCount=$('#itemsCount');
  const carritoEl=$('#carrito'), carritoVacio=$('#carritoVacio'), totalEl=$('#total'), enviarBtn=$('#enviar');
  const status=$('#status'), registroEl=$('#registro');

  // --- Carta ---
  const CARTA=[
    {id:'hamb_carne',cat:'hamburguesas',nombre:'Hamburguesa de Carne',precio:10,desc:'Carne, papas y ensalada',opciones:{cremas:['Mayonesa','Ketchup','Mostaza','Aceituna','Aji','Tartara','Salsa Golf','Chimichurri'],papas:['frita','hilo','mixtas'],ensalada:['lechuga','tomate','completo','sin ensalada']}},
    {id:'hamb_royal_carne',cat:'hamburguesas',nombre:'Hamburguesa Royal Carne',precio:13,desc:'Carne, huevo, queso, papas y ensalada',opciones:{cremas:['Mayonesa','Ketchup','Mostaza','Aceituna','Aji','Tartara','Salsa Golf','Chimichurri'],papas:['frita','hilo','mixtas'],ensalada:['lechuga','tomate','completo','sin ensalada']}},
    {id:'hamb_filete_pollo',cat:'hamburguesas',nombre:'Hamburguesa Filete de Pollo',precio:10,desc:'Filete de pollo, papas y ensalada',opciones:{cremas:['Mayonesa','Ketchup','Mostaza','Aceituna','Aji','Tartara','Salsa Golf','Chimichurri'],papas:['frita','hilo','mixtas'],ensalada:['lechuga','tomate','completo','sin ensalada']}},
    {id:'hamb_royal_pollo',cat:'hamburguesas',nombre:'Hamburguesa Royal Pollo',precio:13,desc:'Filete de pollo, huevo, queso, papas y ensalada',opciones:{cremas:['Mayonesa','Ketchup','Mostaza','Aceituna','Aji','Tartara','Salsa Golf','Chimichurri'],papas:['frita','hilo','mixtas'],ensalada:['lechuga','tomate','completo','sin ensalada']}},
    {id:'hamb_chorizo',cat:'hamburguesas',nombre:'Hamburguesa de Chorizo',precio:9,desc:'Chorizo, papas y ensalada',opciones:{cremas:['Mayonesa','Ketchup','Mostaza','Aceituna','Aji','Tartara','Salsa Golf','Chimichurri'],papas:['frita','hilo','mixtas'],ensalada:['lechuga','tomate','completo','sin ensalada']}},
    {id:'hamb_cordero',cat:'hamburguesas',nombre:'Hamburguesa de Cordero',precio:13,desc:'Cordero, papas y ensalada',opciones:{cremas:['Mayonesa','Ketchup','Mostaza','Aceituna','Aji','Tartara','Salsa Golf','Chimichurri'],papas:['frita','hilo','mixtas'],ensalada:['lechuga','tomate','completo','sin ensalada']}},
    {id:'salchi_clasica',cat:'salchipapas',nombre:'Salchipapa clÃ¡sica / ahumadas',precio:10,desc:'Papa y HotDog',opciones:{cremas:['Mayonesa','Ketchup','Mostaza','Aceituna','Aji','Tartara','Salsa Golf','Chimichurri'],papas:['frita','hilo','mixtas'],ensalada:['lechuga','tomate','completo','sin ensalada']}},
    {id:'parr_cerdo',cat:'parrillas',nombre:'Parrillada de Cerdo',precio:27,desc:'2 presas, choclo, ensalada, chorizo'},
    {id:'parr_res',cat:'parrillas',nombre:'Parrillada de Res',precio:27,desc:'2 presas, choclo, ensalada, chorizo'},
    {id:'parr_pollo',cat:'parrillas',nombre:'Parrillada de Pollo',precio:27,desc:'2 presas, choclo, ensalada, chorizo'},
    {id:'parr_cordero',cat:'parrillas',nombre:'Parrillada de Cordero',precio:27,desc:'2 presas, choclo, ensalada, chorizo'},
    {id:'costillar_cordero',cat:'parrillas',nombre:'Costillar de Cordero',precio:36,desc:'6 tiras, choclo, ensalada, chorizo'}
  ];

  const cremaColors={'Mayonesa':'#fff8db','Ketchup':'#c81d25','Mostaza':'#f59e0b','Aceituna':'#6b7280','Aji':'#ef4444','Tartara':'#e5e7eb','Salsa Golf':'#fbbf24','Chimichurri':'#16a34a'};

  const cart=[];

  function pintarMenu(){
    const q=(buscarEl.value||'').toLowerCase(); const cat=catEl.value;
    const data=CARTA.filter(x=>(!cat||x.cat===cat)&&(x.nombre.toLowerCase().includes(q)||x.cat.includes(q)));
    itemsCount.textContent=`${data.length} Ã­tems`;
    menuEl.innerHTML=data.map(x=>`<div class="item">
      <div class="row" style="justify-content:space-between">
        <h3>${x.nombre}</h3>
        <span class="price">S/ ${x.precio.toFixed(2)}</span>
      </div>
      ${x.desc?`<small class="muted">${x.desc}</small>`:''}
      ${x.opciones?'<small class="muted">Incluye opciones</small>':'<small class="muted">Solo cantidad</small>'}
      <div class="row">
        <button data-id="${x.id}" class="add">Agregar</button>
        <button data-id="${x.id}" class="custom ghost">Personalizar</button>
      </div>
    </div>`).join('');
    menuEl.querySelectorAll('button.add').forEach(b=>b.onclick=()=>agregar(b.dataset.id));
    menuEl.querySelectorAll('button.custom').forEach(b=>b.onclick=()=>personalizar(b.dataset.id));
  }

  function agregar(id,custom={}){
    const it=CARTA.find(i=>i.id===id);
    cart.push({ id:it.id,nombre:it.nombre,precio:it.precio,
      cremas:custom.cremas||null,papas:custom.papas||null,ensalada:custom.ensalada||null,
      detCremas:custom.detCremas||null,detPapas:custom.detPapas||null, ts:Date.now()
    });
    pintarCarrito();
  }

  function personalizar(id){
    const it=CARTA.find(i=>i.id===id);
    if(!it.opciones){agregar(id);return;}
    abrirModal(it);
  }

  function abrirModal(item){
    const body=document.getElementById('modalBody');
    document.getElementById('modalTitle').textContent=`Personalizar Â· ${item.nombre}`;

    const cremasHTML=item.opciones.cremas.map(c=>`
      <label class="opt"><span class="sw" style="background:${cremaColors[c]||'#94a3b8'}"></span>
        <input type="checkbox" name="cremas" value="${c}"> ${c}
      </label>`).join('');

    const papasHTML=item.opciones.papas.map(p=>`
      <label class="opt"><input type="radio" name="papas" value="${p}"> ${p}</label>`).join('');

    const ensaladaHTML=item.opciones.ensalada.map(e=>`
      <label class="opt"><input type="radio" name="ensalada" value="${e}"> ${e}</label>`).join('');

    body.innerHTML=`
      <div>
        <strong>Cremas</strong>
        <div class="opts">${cremasHTML}</div>
        <textarea id="detCremas" placeholder="Detalles opcionales de cremas (ej. poca mayonesa)"></textarea>
      </div>
      <div style="margin-top:10px">
        <strong>Tipo de papas</strong>
        <div class="opts">${papasHTML}</div>
        <textarea id="detPapas" placeholder="Detalles opcionales de papas (ej. bien crocantes)"></textarea>
      </div>
      <div style="margin-top:10px">
        <strong>Ensalada</strong>
        <div class="opts">${ensaladaHTML}</div>
      </div>`;

    const modal=document.getElementById('modal');
    modal.classList.add('show');
    modal.dataset.itemId=item.id;
  }

  document.getElementById('cancelar').onclick=()=>document.getElementById('modal').classList.remove('show');
  document.getElementById('modal').addEventListener('click',e=>{ if(e.target.id==='modal') e.currentTarget.classList.remove('show'); });
  document.getElementById('cerrarModal').onclick=()=>document.getElementById('modal').classList.remove('show');
  window.addEventListener('keydown',e=>{ if(e.key==='Escape'){ document.getElementById('modal').classList.remove('show'); }});

  document.getElementById('guardarPersonalizacion').onclick=()=>{
    const modal=document.getElementById('modal');
    const id=modal.dataset.itemId;
    const cremas=[...document.querySelectorAll('input[name="cremas"]:checked')].map(x=>x.value);
    const papas=(document.querySelector('input[name="papas"]:checked')||{}).value||null;
    const ensalada=(document.querySelector('input[name="ensalada"]:checked')||{}).value||null;
    const detCremas=document.getElementById('detCremas').value.trim()||null;
    const detPapas=document.getElementById('detPapas').value.trim()||null;
    agregar(id,{cremas,papas,ensalada,detCremas,detPapas});
    modal.classList.remove('show');
  }

  function pintarCarrito(){
    carritoEl.innerHTML='';
    carritoVacio.style.display = cart.length ? 'none':'block';
    let suma=0;
    cart.forEach((l,i)=>{
      suma+=l.precio;
      const div=document.createElement('div'); div.className='item';
      const detalles=(l.cremas||l.papas||l.ensalada||l.detCremas||l.detPapas)
        ? `<small class="muted">${l.cremas?`Cremas: ${l.cremas.join(', ')} Â· `:''}${l.papas?`Papas: ${l.papas} Â· `:''}${l.ensalada?`Ensalada: ${l.ensalada} Â· `:''}${l.detCremas?`Det. cremas: ${l.detCremas} Â· `:''}${l.detPapas?`Det. papas: ${l.detPapas}`:''}</small>` : '';
      div.innerHTML=`<div class="row" style="justify-content:space-between">
          <strong>${l.nombre}</strong><span class="price">S/ ${l.precio.toFixed(2)}</span></div>
        ${detalles}
        <div class="row">
          <button class="ghost" data-i="${i}" data-act="dup">Duplicar</button>
          <button class="ghost" data-i="${i}" data-act="del" style="margin-left:auto">Eliminar</button>
        </div>`;
      carritoEl.appendChild(div);
    });
    totalEl.textContent=`S/ ${suma.toFixed(2)}`;
    carritoEl.querySelectorAll('button').forEach(b=>{
      const i=+b.dataset.i, act=b.dataset.act; if(isNaN(i)) return;
      b.onclick=()=>{ if(act==='del') cart.splice(i,1); if(act==='dup') cart.splice(i+1,0,{...cart[i],ts:Date.now()}); pintarCarrito(); }
    });
  }

  enviarBtn.onclick=async()=>{
    if(cart.length===0){alert('Agrega productos');return;}
    const cliente=$('#cliente').value.trim();
    const pago=$('#pago').value;
    const pedido={cliente:cliente||null,pago,items:cart,total:cart.reduce((a,b)=>a+b.precio,0),ts:Date.now()};
    try{enviarBtn.disabled=true;await push(ref(db,'pedidos'),pedido);cart.length=0;pintarCarrito();alert('âœ… Pedido enviado');}
    catch(e){alert('Error:'+e.message);}
    finally{enviarBtn.disabled=false;}
  };

  // Registro: render y toggle pagado/pendiente
  function renderPedido(key, p){
    let div = registroEl.querySelector(`.pedido[data-key="${key}"]`);
    const d = new Date(p.ts);
    const items = (p.items||[]).map(i=>`â€¢ ${i.nombre}${i.papas?` (${i.papas})`:''}`).join('<br>');
    const pagoTxt = p.pago === 'pagado' ? 'Pagado' : 'Por pagar';
    if(!div){ div=document.createElement('div'); div.className='pedido'; div.dataset.key=key; registroEl.prepend(div); }
    div.innerHTML = `<div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <strong>${p.cliente||'Sin nombre'}</strong> â€” <span class="badge">${pagoTxt}</span><br>
          ${items}<br>
          Total: S/ ${Number(p.total||0).toFixed(2)} <small class="muted">${d.toLocaleString()}</small>
        </div>
        <div class="row">
          <button class="ghost" data-act="toggle" data-key="${key}">${p.pago==='pagado'?'Marcar pendiente':'Marcar pagado'}</button>
        </div>
      </div>`;
    div.querySelector('button[data-act="toggle"]').onclick = async ()=>{
      const nuevo = (p.pago === 'pagado') ? 'pendiente' : 'pagado';
      try{ await update(ref(db, `pedidos/${key}`), { pago: nuevo }); }
      catch(e){ alert('No se pudo actualizar: '+(e?.message||e)); }
    };
  }

  onChildAdded(ref(db,'pedidos'), snap => { status.textContent='Conectado'; renderPedido(snap.key, snap.val()); });
  onChildChanged(ref(db,'pedidos'), snap => { renderPedido(snap.key, snap.val()); });

  buscarEl.oninput=pintarMenu; catEl.onchange=pintarMenu;
  pintarMenu(); pintarCarrito();
</script>
</body>
</html>
